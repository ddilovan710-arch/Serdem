<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>💰 نظام محاسبة المتجر</title>
  <style>
    body { font-family: "Cairo", sans-serif; margin:0; background:#f5f6fa; direction:rtl; font-size:20px; }
    header { background:#2c3e50; color:white; padding:25px; text-align:center; font-size:28px; }
    nav { display:flex; justify-content:center; gap:20px; background:#34495e; padding:15px; flex-wrap:wrap; }
    nav button { background:#1abc9c; border:none; color:white; padding:20px 40px; border-radius:12px; cursor:pointer; font-size:22px; font-weight:bold; }
    nav button:hover { background:#16a085; }
    section { display:none; max-width:1000px; margin:30px auto; background:white; padding:30px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.15); font-size:22px; }
    section.active { display:block; }
    label { display:block; margin-top:15px; font-weight:bold; font-size:22px; }
    input,button { margin:8px 0; padding:18px; border-radius:10px; border:1px solid #bbb; width:100%; box-sizing:border-box; font-size:22px; }
    button.action { background:#3498db; color:white; border:none; width:100%; font-size:24px; font-weight:bold; }
    button.action:hover { background:#2980b9; }
    table { width:100%; border-collapse:collapse; margin-top:20px; font-size:20px; }
    th,td { border:1px solid #ddd; padding:12px; text-align:center; }
    th { background:#ecf0f1; font-size:22px; }
    #scanner { display:none; margin:15px auto; width:300px; height:300px; border:3px solid #2980b9; }
    .btn-sm { padding:10px 20px; font-size:20px; margin:5px; border-radius:8px; cursor:pointer; }
    .edit { background:#f39c12; color:white; border:none; }
    .delete { background:#e74c3c; color:white; border:none; }
    #lastScan { text-align:center; font-size:24px; margin-top:10px; font-weight:bold; color:#2c3e50; }
  </style>
</head>
<body>
  <header>💰 نظام محاسبة المتجر</header>
  <nav>
    <button onclick="showPage('sell')">💵 البيع</button>
    <button onclick="showPage('products')">🛒 المنتجات</button>
    <button onclick="showPage('profit')">📈 صافي الربح</button>
    <button onclick="showPage('history')">📊 السجل</button>
  </nav>

  <!-- صفحة البيع -->
  <section id="sell" class="active">
    <h2>💵 بيع منتج</h2>
    <label>📦 الباركود</label>
    <input id="sellBarcode" placeholder="ادخل الباركود">
    <button class="btn-sm" onclick="startScanner('sell')">📷 مسح باركود</button>

    <label>🔢 الكمية</label>
    <input id="sellQty" type="number" placeholder="الكمية" value="1">

    <label>💲 سعر البيع</label>
    <input id="sellPrice" type="number" placeholder="سعر البيع">

    <button class="action" onclick="processTransaction()">✅ تنفيذ البيع</button>
  </section>

  <!-- صفحة المنتجات -->
  <section id="products">
    <h2>🛒 إدارة المنتجات</h2>
    <label>💲 سعر التكلفة</label>
    <input id="pprice" type="number" placeholder="سعر التكلفة">

    <label>📦 الباركود</label>
    <input id="pbarcode" placeholder="الباركود">
    <button class="btn-sm" onclick="startScanner('product')">📷 مسح باركود</button>

    <label>🔢 الكمية</label>
    <input id="pstock" type="number" placeholder="الكمية">

    <button class="action" onclick="addOrUpdateProduct()">➕ إضافة / تحديث</button>

    <h2>📋 قائمة المنتجات</h2>
    <p>💰 القيمة الكلية للبضاعة: <span id="inventoryValue">0</span></p>
    <table id="productsTable">
      <thead><tr><th>الباركود</th><th>سعر التكلفة</th><th>المخزون</th><th>خيارات</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- صفحة الربح -->
  <section id="profit">
    <h2>📈 صافي الربح</h2>
    <p>💵 إجمالي المبيعات: <span id="totalSales">0</span></p>
    <p>📦 إجمالي التكلفة: <span id="totalCost">0</span></p>
    <p>✅ صافي الربح: <span id="netProfit">0</span></p>
  </section>

  <!-- صفحة السجل -->
  <section id="history">
    <h2>📊 سجل العمليات</h2>
    <button onclick="exportData()">📤 تصدير المبيعات</button>
    <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    <button onclick="document.getElementById('importFile').click()">📥 استيراد المبيعات</button>

    <table id="historyTable">
      <thead><tr><th>النوع</th><th>الباركود</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th>التاريخ</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- الكاميرا -->
  <div id="scanner"></div>
  <div id="lastScan"></div>

  <!-- صوت -->
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <script>
    let products = JSON.parse(localStorage.getItem("products") || "[]");
    let transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
    let scannerMode = null;

    function saveData() {
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("transactions", JSON.stringify(transactions));
    }

    function loadProducts() {
      const tbody = document.querySelector("#productsTable tbody");
      tbody.innerHTML = "";
      let totalValue = 0;
      products.forEach((p) => {
        tbody.innerHTML += `<tr>
          <td>${p.barcode}</td>
          <td>${p.price}</td>
          <td>${p.stock}</td>
          <td>
            <button class="btn-sm edit" onclick="editProduct('${p.barcode}')">✏️ تعديل</button>
            <button class="btn-sm delete" onclick="deleteProduct('${p.barcode}')">🗑️ حذف</button>
          </td>
        </tr>`;
        totalValue += (p.price || 0) * (p.stock || 0);
      });
      document.getElementById("inventoryValue").textContent = totalValue.toFixed(2);
    }

    function addOrUpdateProduct() {
      const price = parseFloat(document.getElementById("pprice").value);
      const barcode = document.getElementById("pbarcode").value;
      const stock = parseInt(document.getElementById("pstock").value);
      if (!barcode) return alert("❌ أدخل الباركود");

      let product = products.find(p => p.barcode === barcode);
      if (product) {
        product.price = price || product.price;
        product.stock += stock || 0;
      } else {
        products.push({ barcode, price, stock });
      }
      saveData(); loadProducts();
    }

    function editProduct(barcode) {
      let product = products.find(p => p.barcode === barcode);
      if (!product) return;
      document.getElementById("pbarcode").value = product.barcode;
      document.getElementById("pprice").value = product.price;
      document.getElementById("pstock").value = product.stock;
      showPage('products');
    }

    function deleteProduct(barcode) {
      products = products.filter(p => p.barcode !== barcode);
      saveData(); loadProducts();
    }

    function recordTransaction(barcode, qty, price) {
      const product = products.find(p => p.barcode === barcode);
      transactions.push({
        type: "بيع",
        barcode,
        qty,
        price,
        total: price * qty,
        cost: (product.price || 0) * qty,
        date: new Date().toLocaleString()
      });
      saveData();
    }

    function processTransaction() {
      const barcode = document.getElementById("sellBarcode").value;
      const qty = parseInt(document.getElementById("sellQty").value);
      const sellPrice = parseFloat(document.getElementById("sellPrice").value);

      let product = products.find(p => p.barcode === barcode);
      if (!product) return alert("❌ المنتج غير موجود");
      if (product.stock < qty) return alert("❌ مخزون غير كافي");

      product.stock -= qty;
      recordTransaction(barcode, qty, sellPrice);
      saveData(); loadProducts();
      alert("✔ تمت عملية البيع");
    }

    function calcProfit() {
      let totalSales = 0, totalCost = 0;
      transactions.forEach(t => {
        totalSales += t.price * t.qty;
        totalCost += t.cost;
      });
      document.getElementById("totalSales").textContent = totalSales.toFixed(2);
      document.getElementById("totalCost").textContent = totalCost.toFixed(2);
      document.getElementById("netProfit").textContent = (totalSales - totalCost).toFixed(2);
    }

    function loadHistory() {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      transactions.forEach(t => {
        tbody.innerHTML += `<tr>
          <td>${t.type}</td>
          <td>${t.barcode}</td>
          <td>${t.qty}</td>
          <td>${t.price}</td>
          <td>${t.total}</td>
          <td>${t.date}</td>
        </tr>`;
      });
    }

    // 📤 تصدير
    function exportData() {
      const dataStr = JSON.stringify(transactions);
      const blob = new Blob([dataStr], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "sales.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // 📥 استيراد ودمج
    function importData(event){
      const file = event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        try {
          const newSales = JSON.parse(e.target.result);
          newSales.forEach(sale=>{
            transactions.push(sale);
            let product = products.find(p=>p.barcode===sale.barcode);
            if(product){
              product.stock = (product.stock||0) - sale.qty;
            }
          });
          saveData(); loadHistory(); loadProducts();
          alert("✅ تم دمج المبيعات وتحديث المخزون");
        } catch(err){
          alert("❌ ملف غير صالح");
        }
      };
      reader.readAsText(file);
    }

    function showPage(id) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id==="products") loadProducts();
      if (id==="history") loadHistory();
      if (id==="profit") calcProfit();
    }

    function startScanner(mode) {
      scannerMode = mode;
      const scanner = document.getElementById("scanner");
      scanner.style.display = "block";
      document.getElementById("lastScan").textContent = "📷 جاري المسح ...";

      if (Quagga.initialized) { Quagga.stop(); }

      Quagga.init({
        inputStream: { type:"LiveStream", constraints:{ facingMode:"environment" }, target:scanner },
        decoder: { readers:["code_128_reader","ean_reader","ean_8_reader"] }
      }, err => { if(err){console.error(err);return;} Quagga.initialized = true; Quagga.start(); });

      Quagga.onDetected(data => {
        let code = data.codeResult.code;
        document.getElementById("beep").play();
        document.getElementById("lastScan").textContent = "✅ آخر باركود: " + code;

        if (scannerMode==="sell") document.getElementById("sellBarcode").value = code;
        if (scannerMode==="product") document.getElementById("pbarcode").value = code;

        Quagga.stop();
        scanner.style.display = "none";
      });
    }

    loadProducts();
  </script>
</body>
</html>
